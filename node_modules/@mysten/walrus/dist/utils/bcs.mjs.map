{"version":3,"file":"bcs.mjs","names":[],"sources":["../../src/utils/bcs.ts"],"sourcesContent":["// Copyright (c) Mysten Labs, Inc.\n// SPDX-License-Identifier: Apache-2.0\n\nimport type { BcsType } from '@mysten/sui/bcs';\nimport { bcs } from '@mysten/sui/bcs';\n\nconst MerkleNode = bcs.enum('MerkleNode', {\n\tEmpty: null,\n\tDigest: bcs.bytes(32),\n});\n\nconst SliverPairMetadata = bcs.struct('SliverPairMetadata', {\n\tprimary_hash: MerkleNode,\n\tsecondary_hash: MerkleNode,\n});\n\nexport const EncodingType = bcs\n\t.enum('EncodingType', {\n\t\tRedStuff: null,\n\t\tRS2: null,\n\t})\n\t.transform({\n\t\tinput: (\n\t\t\tencodingType:\n\t\t\t\t| { RedStuff: boolean | object | null }\n\t\t\t\t| { RS2: boolean | object | null }\n\t\t\t\t| 'RedStuff'\n\t\t\t\t| 'RS2',\n\t\t) =>\n\t\t\ttypeof encodingType === 'string'\n\t\t\t\t? ({ [encodingType]: null } as Exclude<typeof encodingType, string>)\n\t\t\t\t: encodingType,\n\t\toutput: (encodingType) => encodingType,\n\t});\n\nexport const BlobMetadataV1 = bcs.struct('BlobMetadataV1', {\n\tencoding_type: EncodingType,\n\tunencoded_length: bcs.u64(),\n\thashes: bcs.vector(SliverPairMetadata),\n});\n\nexport const BlobMetadata = bcs.enum('BlobMetadata', {\n\tV1: BlobMetadataV1,\n});\n\nexport const BlobId = bcs.u256().transform({\n\tinput: (blobId: string | bigint) => (typeof blobId === 'string' ? blobIdToInt(blobId) : blobId),\n\toutput: (id: string) => blobIdFromInt(id),\n});\n\nexport function blobIdFromInt(blobId: bigint | string): string {\n\treturn bcs\n\t\t.u256()\n\t\t.serialize(blobId)\n\t\t.toBase64()\n\t\t.replace(/=*$/, '')\n\t\t.replaceAll('+', '-')\n\t\t.replaceAll('/', '_');\n}\n\nexport function blobIdFromBytes(blobId: Uint8Array): string {\n\treturn blobIdFromInt(bcs.u256().parse(blobId));\n}\n\nexport function blobIdToInt(blobId: string): bigint {\n\treturn BigInt(bcs.u256().fromBase64(blobId.replaceAll('-', '+').replaceAll('_', '/')));\n}\n\nexport const BlobMetadataWithId = bcs.struct('BlobMetadataWithId', {\n\tblobId: BlobId,\n\tmetadata: BlobMetadata,\n});\n\nconst Symbols = bcs.struct('Symbols', {\n\tdata: bcs.byteVector(),\n\tsymbol_size: bcs.u16(),\n});\n\nexport const SliverData = bcs.struct('SliverData', {\n\tsymbols: Symbols,\n\tindex: bcs.u16(),\n});\n\nexport const Sliver = bcs.enum('Sliver', {\n\tPrimary: SliverData,\n\tSecondary: SliverData,\n});\n\nexport const SliverPair = bcs.struct('SliverPair', {\n\tprimary: SliverData,\n\tsecondary: SliverData,\n});\n\nexport enum IntentType {\n\tPROOF_OF_POSSESSION_MSG = 0,\n\tBLOB_CERT_MSG = 1,\n\tINVALID_BLOB_ID_MSG = 2,\n\tSYNC_SHARD_MSG = 3,\n}\n\nexport const Intent = bcs\n\t.struct('Intent', {\n\t\ttype: bcs.u8().transform({\n\t\t\tinput: (type: IntentType) => type,\n\t\t\toutput: (type: number) => type as IntentType,\n\t\t}),\n\t\tversion: bcs.u8(),\n\t\tappId: bcs.u8(),\n\t})\n\t.transform({\n\t\tinput: (intent: IntentType) => ({\n\t\t\ttype: intent,\n\t\t\tversion: 0,\n\t\t\tappId: 3,\n\t\t}),\n\t\toutput: (intent) => intent.type,\n\t});\n\nexport function ProtocolMessage<T extends BcsType<any>>(messageContents: T) {\n\treturn bcs.struct(`ProtocolMessage<${messageContents.name}>`, {\n\t\tintent: Intent,\n\t\tepoch: bcs.u32(),\n\t\tmessageContents,\n\t});\n}\n\nexport const BlobPersistenceType = bcs.enum('BlobPersistenceType', {\n\tPermanent: null,\n\tDeletable: bcs.struct('Deletable', {\n\t\tobjectId: bcs.Address,\n\t}),\n});\nexport const StorageConfirmationBody = bcs.struct('StorageConfirmationBody', {\n\tblobId: BlobId,\n\tblobType: BlobPersistenceType,\n});\n\nexport const StorageConfirmation = ProtocolMessage(StorageConfirmationBody);\n\nexport function Field<T0 extends BcsType<any>, T1 extends BcsType<any>>(\n\t...typeParameters: [T0, T1]\n) {\n\treturn bcs.struct('Field', {\n\t\tid: bcs.Address,\n\t\tname: typeParameters[0],\n\t\tvalue: typeParameters[1],\n\t});\n}\n\nexport const QuiltPatchTags = bcs.map(bcs.string(), bcs.string()).transform({\n\t// Accept both Record and Map as input, bcs.map() handles sorting automatically\n\tinput: (tags: Record<string, string> | Map<string, string>) =>\n\t\ttags instanceof Map ? tags : new Map(Object.entries(tags)),\n\toutput: (tags: Map<string, string>) => Object.fromEntries(tags),\n});\n\nexport const QuiltPatchV1 = bcs.struct('QuiltPatchV1', {\n\tendIndex: bcs.u16(),\n\tidentifier: bcs.string(),\n\ttags: QuiltPatchTags,\n});\n\nexport const QuiltIndexV1 = bcs.struct('QuiltIndexV1', {\n\tpatches: bcs.vector(QuiltPatchV1),\n});\n\nexport const QuiltPatchId = bcs.struct('QuiltPatchId', {\n\tquiltId: BlobId,\n\tpatchId: bcs.struct('InternalQuiltPatchId', {\n\t\tversion: bcs.u8(),\n\t\tstartIndex: bcs.u16(),\n\t\tendIndex: bcs.u16(),\n\t}),\n});\n\nexport const QuiltPatchBlobHeader = bcs.struct('QuiltPatchBlobHeader', {\n\tversion: bcs.u8(),\n\tlength: bcs.u32(),\n\tmask: bcs.u8(),\n});\n"],"mappings":"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"}